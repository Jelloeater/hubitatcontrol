name: Test

on:
    pull_request: { }
    push:
        branches: [ main ]
        tags: [ "*" ]
#    workflow_dispatch:
jobs:
    test:
        runs-on: [self-hosted, linux]
        steps:
            - run: sudo snap install task --classic
            - uses: actions/checkout@v2
            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  virtualenvs-create: true
                  virtualenvs-in-project: true
                  installer-parallel: true
            - uses: actions/setup-python@v4
              with:
                python-version: '3.10'
                cache: 'poetry'

            - name: Load cached venv
              id: cached-poetry-dependencies
              uses: actions/cache@v3
              with:
                path: .venv
                key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

            - name: Install dependencies
              if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
              run: poetry install --no-interaction --no-root

            - run: task github
              env: # These need to be set in the repo or the builds will fail
                  HUBITAT_API_APP_ID: ${{ secrets.HUBITAT_API_APP_ID }}
                  HUBITAT_API_TOKEN: ${{ secrets.HUBITAT_API_TOKEN }}
                  HUBITAT_HOST: ${{ secrets.HUBITAT_HOST }}
